[10:59:51 AM] 📥 Escaneo encolado: A#01137
[10:59:51 AM] 🧑 User 01137 ready. Awaiting action...
[10:59:54 AM] 📥 Escaneo encolado: IW3136O51R74
[11:00:15 AM] ❌ Clock In falló: ✅ WO Clock In completado
[11:36:10 AM] 📥 Escaneo encolado: A#01137
[11:36:10 AM] 🧑 User 01137 ready. Awaiting action...
[11:36:13 AM] 📥 Escaneo encolado: IW3136O51R74
[11:36:19 AM] ❌ Clock In falló: ❌ Error: tesseract is not installed or it's not in your PATH. See README file for more information.
[11:42:42 AM] 📥 Escaneo encolado: A#01137
[11:42:42 AM] 🧑 User 01137 ready. Awaiting action...
[11:42:44 AM] 📥 Escaneo encolado: IW3136O51R74
[11:42:49 AM] ❌ Clock In falló: ❌ Error: tesseract is not installed or it's not in your PATH. See README file for more information.
[11:44:58 AM] 📥 Escaneo encolado: A#01137
[11:44:58 AM] 🧑 User 01137 ready. Awaiting action...
[11:45:00 AM] 📥 Escaneo encolado: IW3136O51R74
[11:45:05 AM] ❌ Clock In falló: ❌ Error: tesseract is not installed or it's not in your PATH. See README file for more information.
[11:45:59 AM] 📥 Escaneo encolado: A#01137
[11:45:59 AM] 🧑 User 01137 ready. Awaiting action...
[11:46:01 AM] 📥 Escaneo encolado: IW3136O51R74
[11:46:37 AM] ❌ Clock In falló: ❌ No esta el boton job listing
[11:47:59 AM] 📥 Escaneo encolado: A#01137
[11:47:59 AM] 🧑 User 01137 ready. Awaiting action...
[11:48:00 AM] 📥 Escaneo encolado: IW3136O51R74
[11:48:32 AM] 📥 Escaneo encolado: A#01137
[11:48:32 AM] 🧑 User 01137 ready. Awaiting action...
[11:48:34 AM] 📥 Escaneo encolado: IW3136O51R74
[11:49:11 AM] ❌ Clock In falló: ❌ No esta el boton job listing
[11:53:15 AM] 📥 Escaneo encolado: A#01137
[11:53:15 AM] 🧑 User 01137 ready. Awaiting action...
[11:53:17 AM] 📥 Escaneo encolado: IW3136O51R74
[11:53:53 AM] ❌ Clock In falló: ❌ No esta el boton job listing
[11:54:43 AM] 📥 Escaneo encolado: A#01137
[11:54:43 AM] 🧑 User 01137 ready. Awaiting action...
[11:54:44 AM] 📥 Escaneo encolado: IW3136O51R74
[11:56:22 AM] 📥 Escaneo encolado: A#01137
[11:56:22 AM] 🧑 User 01137 ready. Awaiting action...
[11:56:23 AM] 📥 Escaneo encolado: IW3136O51R74
[11:57:27 AM] 📥 Escaneo encolado: A#01137
[11:57:27 AM] 🧑 User 01137 ready. Awaiting action...
[11:57:29 AM] 📥 Escaneo encolado: IW3136O51R74
[11:58:12 AM] 📥 Escaneo encolado: A#01137
[11:58:12 AM] 🧑 User 01137 ready. Awaiting action...
[11:58:15 AM] 📥 Escaneo encolado: IW3136O51R74
[11:59:22 AM] 📥 Escaneo encolado: A#01137
[11:59:22 AM] 🧑 User 01137 ready. Awaiting action...
[11:59:23 AM] 📥 Escaneo encolado: IW3136O51R74
[12:22:48 PM] 📥 Escaneo encolado: A#01137
[12:22:48 PM] 🧑 User 01137 ready. Awaiting action...
[12:22:51 PM] 📥 Escaneo encolado: OW#3136
[12:22:51 PM] ❌ Error ejecutando comando: hacer_clockout() missing 1 required positional argument: 'qty'
[12:28:45 PM] 📥 Escaneo encolado: A#01137
[12:28:45 PM] 🧑 User 01137 ready. Awaiting action...
[12:28:47 PM] 📥 Escaneo encolado: OW#3136
[12:31:09 PM] 📥 Escaneo encolado: A#01137
[12:31:09 PM] 🧑 User 01137 ready. Awaiting action...
[12:31:10 PM] 📥 Escaneo encolado: OW#3136
[12:33:03 PM] 📥 Escaneo encolado: A#01137
[12:33:03 PM] 🧑 User 01137 ready. Awaiting action...
[12:33:05 PM] 📥 Escaneo encolado: OW#3136
[12:35:08 PM] 📥 Escaneo encolado: A#01137
[12:35:08 PM] 🧑 User 01137 ready. Awaiting action...
[12:35:09 PM] 📥 Escaneo encolado: OW#3136
[12:39:34 PM] 📥 Escaneo encolado: A#01137
[12:39:34 PM] 🧑 User 01137 ready. Awaiting action...
[12:39:36 PM] 📥 Escaneo encolado: OW#3136
[12:40:37 PM] 📥 Escaneo encolado: A#01137
[12:40:37 PM] 🧑 User 01137 ready. Awaiting action...
[12:40:40 PM] 📥 Escaneo encolado: OW#3136
[12:41:57 PM] 📥 Escaneo encolado: A#01137
[12:41:57 PM] 🧑 User 01137 ready. Awaiting action...
[12:41:59 PM] 📥 Escaneo encolado: OW#3136
[12:43:03 PM] 📥 Escaneo encolado: A#01137
[12:43:03 PM] 🧑 User 01137 ready. Awaiting action...
[12:43:05 PM] 📥 Escaneo encolado: OW#3136
[12:56:50 PM] 📥 Escaneo encolado: A#01137
[12:56:50 PM] 🧑 User 01137 ready. Awaiting action...
[12:56:52 PM] 📥 Escaneo encolado: OW#3136
[12:57:38 PM] ❌ Clock Out falló: ❌ No aparece el campo qty
[1:03:06 PM] 📥 Escaneo encolado: A#01137
[1:03:06 PM] 🧑 User 01137 ready. Awaiting action...
[1:03:07 PM] 📥 Escaneo encolado: OW#3136
[1:03:24 PM] ❌ Clock Out falló: ❌ No se abrio la ventana del qty
[1:05:47 PM] 📥 Escaneo encolado: A#01137
[1:05:47 PM] 🧑 User 01137 ready. Awaiting action...
[1:05:48 PM] 📥 Escaneo encolado: OW#3136
[1:07:09 PM] 📥 Escaneo encolado: A#01137
[1:07:09 PM] 🧑 User 01137 ready. Awaiting action...
[1:07:10 PM] 📥 Escaneo encolado: OW#3136
[1:08:35 PM] 📥 Escaneo encolado: A#01137
[1:08:35 PM] 🧑 User 01137 ready. Awaiting action...
[1:08:37 PM] 📥 Escaneo encolado: OW#3136
[1:09:53 PM] 📥 Escaneo encolado: A#01137
[1:09:53 PM] 🧑 User 01137 ready. Awaiting action...
[1:09:54 PM] 📥 Escaneo encolado: OW#3136
[1:16:02 PM] 📥 Escaneo encolado: A#01137
[1:16:02 PM] 🧑 User 01137 ready. Awaiting action...
[1:16:05 PM] 📥 Escaneo encolado: OW#3136
[1:16:21 PM] ❌ Clock Out falló: ❌ No se abrio la ventana del qty
[1:22:26 PM] 📥 Escaneo encolado: A#01137
[1:22:26 PM] 🧑 User 01137 ready. Awaiting action...
[1:22:28 PM] 📥 Escaneo encolado: OW#3136
[1:22:45 PM] ❌ Clock Out falló: ❌ No aparece la ventana
[1:23:33 PM] 📥 Escaneo encolado: A#01137
[1:23:33 PM] 🧑 User 01137 ready. Awaiting action...
[1:23:33 PM] 📥 Escaneo encolado: OW#3136
[1:23:53 PM] ❌ Clock Out falló: ❌ No aparece la ventana
[1:25:07 PM] 📥 Escaneo encolado: A#01137
[1:25:07 PM] 🧑 User 01137 ready. Awaiting action...
[1:25:08 PM] 📥 Escaneo encolado: OW#3136
[1:25:29 PM] ❌ Clock Out falló: ❌ No aparece la ventana
[1:27:58 PM] 📥 Escaneo encolado: A#01137
[1:27:58 PM] 🧑 User 01137 ready. Awaiting action...
[1:27:59 PM] 📥 Escaneo encolado: OW#3136
[1:28:18 PM] ❌ Clock Out falló: ❌ No aparece la ventana
[1:31:21 PM] 📥 Escaneo encolado: A#01137
[1:31:21 PM] 🧑 User 01137 ready. Awaiting action...
[1:31:23 PM] 📥 Escaneo encolado: OW#3136
[1:44:11 PM] 📥 Escaneo encolado: A#01137
[1:44:11 PM] 🧑 User 01137 ready. Awaiting action...
[1:44:12 PM] 📥 Escaneo encolado: OW#3136
[1:45:06 PM] ❌ Clock Out falló: ❌ No se pudo interpretar la cantidad: 'import time
import pyautogui
import pygetwindow as gw
import pyperclip
import keyboard
from PIL import ImageGrab
import pytesseract
import numpy as np

from utils.windows import activar_ventana
from utils.input import safe_click, safe_write, safe_press_enter, safe_hotkey
from utils.hook_control import stop_hook, start_hook
from utils.modals import show_qty_modal
import utils.hook_listener as hook_listener


def esperar_color(bbox, color_fn, timeout=10):
    """
    Espera hasta que el área dada cumpla la condición de color.
    color_fn debe ser una función como es_azul, es_gris, etc.
    """
    start = time.time()
    while time.time() - start < timeout:
        if color_fn(bbox):
            return True
        time.sleep(0.3)
    return False


def hacer_clockout(user_code, wo_number):
    try:
        print(f"➡️ ClockOut | User: {user_code}, WO: {wo_number}")

        ventanas = gw.getWindowsWithTitle("Mie Kiosk")
        if not ventanas:
            return "❌ No se encontró ventana con título 'Mie Kiosk'"

        win = ventanas[0]
        activar_ventana(win)

        safe_click(161, 57)  # home_btn
        safe_click(709, 466)  # login_box
        safe_write(user_code)
        safe_press_enter()

        safe_click(825, 274)  # wo_header
        safe_write(wo_number)

        if not esperar_color((106, 298, 124, 310), es_azul):
            return "❌ No aparece el botón logout"
        safe_click(111, 300)  # logout_btn

        if not esperar_color((761, 332, 791, 349), es_gris):
            return "❌ No aparece la ventana gris"

        safe_click(839, 441)  # qty_input

        if not esperar_color((776, 369, 814, 397), es_amarillo):
            return "❌ No aparece la ventana amarilla"

        # Desactivar hook y mostrar modal
        stop_hook()
        show_qty_modal()
        print("⌨️ Esperando que el usuario presione ENTER...")
        keyboard.wait("enter")
        start_hook(hook_listener.on_key)

        # Leer cantidad desde el campo qty
        safe_click(839, 441)
        safe_hotkey("ctrl", "c")
        time.sleep(0.3)
        texto = pyperclip.paste()

        try:
            qty = float(texto.strip())
        except ValueError:
            return f"❌ No se pudo interpretar la cantidad: '{texto}'"

        # Leer Remaining Qty
        safe_click(1359, 490)
        safe_hotkey("ctrl", "c")
        time.sleep(0.3)
        texto = pyperclip.paste()

        try:
            remaining = float(texto.strip())
        except ValueError:
            return f"❌ No se pudo interpretar Remaining Qty: '{texto}'"

        if qty < remaining:
            status = "Incomplete"
            print("⚠️ Marcado como Incomplete")
            safe_click(759, 893)
        else:
            status = "Complete"
            print("✅ Marcado como Complete")
            safe_click(876, 900)

        safe_click(1882, 680)  # close_filter
        safe_click(161, 57)   # home_btn

        return f"✅ Clock Out '{status}' completado con qty={qty} vs remaining={remaining}"

    except Exception as e:
        return f"❌ Error: {str(e)}"


def es_azul(bbox, threshold=0.6):
    img = ImageGrab.grab(bbox)
    pixels = np.array(img)
    r = pixels[:, :, 0]
    g = pixels[:, :, 1]
    b = pixels[:, :, 2]
    azul_mask = (b > 100) & (b > r + 30) & (b > g + 30)
    porcentaje_azul = azul_mask.sum() / azul_mask.size
    print(f"🔵 Área azul detectada: {porcentaje_azul:.2%}")
    return porcentaje_azul >= threshold


def es_gris(bbox, threshold=0.6):
    img = ImageGrab.grab(bbox)
    pixels = np.array(img)
    r = pixels[:, :, 0].astype(int)
    g = pixels[:, :, 1].astype(int)
    b = pixels[:, :, 2].astype(int)
    gris_mask = (abs(r - g) < 15) & (abs(r - b) < 15) & (abs(g - b) < 15)
    porcentaje_gris = gris_mask.sum() / gris_mask.size
    print(f"⬜ Área gris detectada: {porcentaje_gris:.2%}")
    return porcentaje_gris >= threshold


def es_amarillo(bbox, threshold=0.6):
    img = ImageGrab.grab(bbox)
    pixels = np.array(img)
    r = pixels[:, :, 0].astype(int)
    g = pixels[:, :, 1].astype(int)
    b = pixels[:, :, 2].astype(int)
    amarillo_mask = (r > 200) & (g > 200) & (b < r - 20) & (b < g - 20)
    porcentaje_amarillo = amarillo_mask.sum() / amarillo_mask.size
    print(f"🟡 Área amarilla detectada: {porcentaje_amarillo:.2%}")
    return porcentaje_amarillo >= threshold
'
[1:59:08 PM] 📥 Escaneo encolado: A#01137
[1:59:08 PM] 🧑 User 01137 ready. Awaiting action...
[1:59:08 PM] 📥 Escaneo encolado: OW#3136
[1:59:16 PM] ✅ Clock Out exitoso en WO 3136
[2:00:36 PM] 📥 Escaneo encolado: A#01137
[2:00:36 PM] 🧑 User 01137 ready. Awaiting action...
[2:00:37 PM] 📥 Escaneo encolado: OW#3136
[2:00:45 PM] ✅ Clock Out exitoso en WO 3136
[2:06:00 PM] 📥 Escaneo encolado: A#01137
[2:06:00 PM] 🧑 User 01137 ready. Awaiting action...
[2:06:03 PM] 📥 Escaneo encolado: OW#3136
[2:06:32 PM] 📥 Escaneo encolado: A#01137
[2:06:33 PM] 📥 Escaneo encolado: OW#3136
[2:06:43 PM] 📥 Escaneo encolado: A#01137
[2:06:43 PM] 🧑 User 01137 ready. Awaiting action...
[2:06:45 PM] 📥 Escaneo encolado: OW#3136
[2:07:32 PM] 📥 Escaneo encolado: A#01137
[2:07:32 PM] 🧑 User 01137 ready. Awaiting action...
[2:07:33 PM] 📥 Escaneo encolado: OW#3136
[2:12:33 PM] 📥 Escaneo encolado: A#01137
[2:12:33 PM] 🧑 User 01137 ready. Awaiting action...
[2:12:36 PM] 📥 Escaneo encolado: OW#3136
[2:13:15 PM] 📥 Escaneo encolado: A#01137
[2:13:15 PM] 🧑 User 01137 ready. Awaiting action...
[2:13:16 PM] 📥 Escaneo encolado: OW#3136
[2:15:30 PM] 📥 Escaneo encolado: A#01137
[2:15:30 PM] 🧑 User 01137 ready. Awaiting action...
[2:15:31 PM] 📥 Escaneo encolado: OW#3136
[2:15:38 PM] ✅ Clock Out exitoso en WO 3136
[2:25:37 PM] 📥 Escaneo encolado: A#01137
[2:25:37 PM] 🧑 User 01137 ready. Awaiting action...
[2:25:41 PM] 📥 Escaneo encolado: IW3136O51R86
[2:25:48 PM] ❌ Clock In falló: ✅ WO Clock In completado
[2:27:04 PM] 📥 Escaneo encolado: A#01137
[2:27:04 PM] 🧑 User 01137 ready. Awaiting action...
[2:27:10 PM] 📥 Escaneo encolado: IW3136O51R86
[2:27:17 PM] ✅ Clock In exitoso en WO 3136
[2:27:33 PM] 📥 Escaneo encolado: A#01137
[2:27:33 PM] 🧑 User 01137 ready. Awaiting action...
[2:27:35 PM] 📥 Escaneo encolado: IW3136O51R86
[2:27:42 PM] ✅ Clock In exitoso en WO 3136
[2:27:51 PM] 📥 Escaneo encolado: IW3136O51R86
[2:28:06 PM] 📥 Escaneo encolado: A#01137
[2:28:06 PM] 🧑 User 01137 ready. Awaiting action...
[2:28:11 PM] 📥 Escaneo encolado: IW3136O51R86
[2:28:18 PM] ❌ Clock In falló: ✅ WO Clock In completado
[2:29:21 PM] 📥 Escaneo encolado: A#01137
[2:29:21 PM] 🧑 User 01137 ready. Awaiting action...
[2:29:26 PM] 📥 Escaneo encolado: IW3136O51R86
[2:29:34 PM] ✅ Clock In exitoso en WO 3136
[2:29:48 PM] 📥 Escaneo encolado: A#01137
[2:29:48 PM] 🧑 User 01137 ready. Awaiting action...
[2:29:50 PM] 📥 Escaneo encolado: IW3136O51R86
[2:29:59 PM] ✅ Clock In exitoso en WO 3136
[2:30:08 PM] 📥 Escaneo encolado: A#01137
[2:30:08 PM] 🧑 User 01137 ready. Awaiting action...
[2:30:10 PM] 📥 Escaneo encolado: OW#3136
[2:30:21 PM] ❌ Clock Out falló: ❌ No se pudo interpretar la cantidad: 'import numpy as np'
[2:31:07 PM] 📥 Escaneo encolado: A#01137
[2:31:07 PM] 🧑 User 01137 ready. Awaiting action...
[2:31:11 PM] 📥 Escaneo encolado: OW#3136
[2:31:17 PM] ❌ Clock Out falló: ❌ No se pudo interpretar la cantidad: 'import numpy as np'
[2:35:00 PM] 📥 Escaneo encolado: A#01137
[2:35:00 PM] 🧑 User 01137 ready. Awaiting action...
[2:35:01 PM] 📥 Escaneo encolado: IW3136O51R86
[2:35:01 PM] ⚠️ Ya tienes un Clock In activo.
[2:35:09 PM] 📥 Escaneo encolado: A#01137
[2:35:09 PM] 🧑 User 01137 ready. Awaiting action...
[2:35:11 PM] 📥 Escaneo encolado: OW#3136
[2:35:18 PM] ✅ Clock Out exitoso en WO 3136
[3:16:51 PM] 📥 Escaneo encolado: A#01137
[3:16:51 PM] ❌ Error ejecutando comando: process_code() takes 1 positional argument but 4 were given
[3:20:06 PM] 📥 Escaneo encolado: A#01137
[3:20:06 PM] 👤 Usuario escaneado: 01137
[3:20:12 PM] 📥 Escaneo encolado: 3136O51R86
[3:20:21 PM] ❌ Clock In falló: ✅ WO Clock In completado
[3:21:36 PM] 📥 Escaneo encolado: A#01137
[3:21:36 PM] 👤 Usuario escaneado: 01137
[3:21:39 PM] 📥 Escaneo encolado: 3136O51R97
[3:21:48 PM] ✅ Clock In exitoso en WO 3136
[3:21:51 PM] 📥 Escaneo encolado: A#01137
[3:21:51 PM] 👤 Usuario escaneado: 01137
[3:21:52 PM] 📥 Escaneo encolado: 3136O51R97
[3:28:29 PM] 📥 Escaneo encolado: A#01137
[3:28:29 PM] 👤 Usuario escaneado: 01137
[3:28:39 PM] 📥 Escaneo encolado: 3136O51R97
[3:28:49 PM] ✅ Clock In exitoso en WO 3136
[3:28:54 PM] 📥 Escaneo encolado: A#01137
[3:28:54 PM] 👤 Usuario escaneado: 01137
[3:28:56 PM] 📥 Escaneo encolado: 3136O51R97
